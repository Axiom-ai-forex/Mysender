<!-- templates/campaigns/results.html -->
{% extends "base.html" %}

{% block title %}Campaign Results - {{ campaign.name }} - Email Sender Pro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Advanced Analytics Dashboard Styles */
:root {
    --analytics-primary: #2563eb;
    --analytics-secondary: #64748b;
    --analytics-success: #10b981;
    --analytics-warning: #f59e0b;
    --analytics-danger: #ef4444;
    --analytics-info: #3b82f6;
    --analytics-purple: #8b5cf6;
    --analytics-pink: #ec4899;
    --analytics-indigo: #6366f1;
    --analytics-teal: #14b8a6;
    --analytics-orange: #f97316;
    --analytics-gray-50: #f9fafb;
    --analytics-gray-100: #f3f4f6;
    --analytics-gray-200: #e5e7eb;
    --analytics-gray-300: #d1d5db;
    --analytics-gray-400: #9ca3af;
    --analytics-gray-500: #6b7280;
    --analytics-gray-600: #4b5563;
    --analytics-gray-700: #374151;
    --analytics-gray-800: #1f2937;
    --analytics-gray-900: #111827;
    --analytics-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --analytics-shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --analytics-shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

body {
    background: var(--analytics-gray-50);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.analytics-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

/* Header Section */
.analytics-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem 2rem;
    border-radius: 24px;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.analytics-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="0,100 0,0 1000,0 1000,80"/></svg>') no-repeat;
    background-size: cover;
}

.header-content {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: between;
    gap: 2rem;
}

.header-left {
    flex: 1;
}

.campaign-title {
    font-size: 2.25rem;
    font-weight: 800;
    margin: 0 0 0.75rem 0;
    line-height: 1.1;
    background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.campaign-subtitle {
    font-size: 1.125rem;
    opacity: 0.9;
    margin: 0 0 1.5rem 0;
    font-weight: 400;
}

.campaign-meta {
    display: flex;
    align-items: center;
    gap: 2rem;
    font-size: 0.875rem;
    opacity: 0.8;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.action-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    backdrop-filter: blur(10px);
}

.btn-white {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-white:hover {
    background: rgba(255, 255, 255, 0.3);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
}

/* Stats Overview */
.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: var(--analytics-shadow);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--analytics-shadow-lg);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--card-color, var(--analytics-primary)) 0%, var(--card-color-light, #93c5fd) 100%);
}

.stat-card.sent {
    --card-color: var(--analytics-primary);
    --card-color-light: #93c5fd;
}

.stat-card.delivered {
    --card-color: var(--analytics-success);
    --card-color-light: #86efac;
}

.stat-card.opened {
    --card-color: var(--analytics-warning);
    --card-color-light: #fcd34d;
}

.stat-card.clicked {
    --card-color: var(--analytics-purple);
    --card-color-light: #c4b5fd;
}

.stat-card.bounced {
    --card-color: var(--analytics-danger);
    --card-color-light: #fca5a5;
}

.stat-card.unsubscribed {
    --card-color: var(--analytics-orange);
    --card-color-light: #fdba74;
}

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    background: linear-gradient(135deg, var(--card-color, var(--analytics-primary)) 0%, var(--card-color-light, #93c5fd) 100%);
}

.stat-trend {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    background: var(--analytics-gray-100);
    color: var(--analytics-gray-600);
}

.trend-up {
    color: var(--analytics-success);
    background: rgba(16, 185, 129, 0.1);
}

.trend-down {
    color: var(--analytics-danger);
    background: rgba(239, 68, 68, 0.1);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--analytics-gray-900);
    margin: 0 0 0.25rem 0;
    line-height: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--analytics-gray-600);
    margin: 0 0 0.5rem 0;
    font-weight: 500;
}

.stat-percentage {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--card-color, var(--analytics-primary));
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Charts Section */
.charts-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: var(--analytics-shadow);
}

.chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--analytics-gray-100);
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--analytics-gray-900);
    margin: 0;
}

.chart-subtitle {
    font-size: 0.875rem;
    color: var(--analytics-gray-600);
    margin: 0.25rem 0 0 0;
}

.chart-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.chart-toggle {
    display: flex;
    background: var(--analytics-gray-100);
    border-radius: 8px;
    padding: 0.25rem;
}

.toggle-btn {
    padding: 0.5rem 1rem;
    background: none;
    border: none;
    color: var(--analytics-gray-600);
    font-weight: 600;
    font-size: 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.toggle-btn.active {
    background: white;
    color: var(--analytics-primary);
    box-shadow: var(--analytics-shadow);
}

.chart-container {
    position: relative;
    height: 400px;
    margin-top: 1rem;
}

.chart-canvas {
    max-height: 400px;
}

/* Tables Section */
.tables-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.table-card {
    background: white;
    border-radius: 16px;
    box-shadow: var(--analytics-shadow);
    overflow: hidden;
}

.table-header {
    padding: 1.5rem 2rem;
    background: var(--analytics-gray-50);
    border-bottom: 1px solid var(--analytics-gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.table-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--analytics-gray-900);
    margin: 0;
}

.table-count {
    font-size: 0.875rem;
    color: var(--analytics-gray-600);
    background: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: var(--analytics-gray-50);
}

.data-table th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--analytics-gray-700);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--analytics-gray-200);
}

.data-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--analytics-gray-100);
    font-size: 0.875rem;
    color: var(--analytics-gray-900);
}

.data-table tr:hover {
    background: var(--analytics-gray-50);
}

.email-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-delivered {
    background: rgba(16, 185, 129, 0.1);
    color: var(--analytics-success);
}

.badge-opened {
    background: rgba(251, 191, 36, 0.1);
    color: var(--analytics-warning);
}

.badge-clicked {
    background: rgba(139, 92, 246, 0.1);
    color: var(--analytics-purple);
}

.badge-bounced {
    background: rgba(239, 68, 68, 0.1);
    color: var(--analytics-danger);
}

.badge-pending {
    background: rgba(107, 114, 128, 0.1);
    color: var(--analytics-gray-600);
}

/* Export Section */
.export-section {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: var(--analytics-shadow);
    text-align: center;
}

.export-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--analytics-gray-900);
    margin: 0 0 1rem 0;
}

.export-subtitle {
    font-size: 1rem;
    color: var(--analytics-gray-600);
    margin: 0 0 2rem 0;
    line-height: 1.6;
}

.export-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.export-btn {
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    border: 2px solid;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    min-width: 140px;
    justify-content: center;
}

.btn-outline-primary {
    background: transparent;
    color: var(--analytics-primary);
    border-color: var(--analytics-primary);
}

.btn-outline-primary:hover {
    background: var(--analytics-primary);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
}

.btn-outline-success {
    background: transparent;
    color: var(--analytics-success);
    border-color: var(--analytics-success);
}

.btn-outline-success:hover {
    background: var(--analytics-success);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
}

.btn-outline-warning {
    background: transparent;
    color: var(--analytics-warning);
    border-color: var(--analytics-warning);
}

.btn-outline-warning:hover {
    background: var(--analytics-warning);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
}

/* Loading States */
.loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton-line {
    height: 1rem;
    border-radius: 4px;
    margin: 0.5rem 0;
}

.skeleton-circle {
    width: 48px;
    height: 48px;
    border-radius: 50%;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .analytics-container {
        padding: 1rem;
    }
    
    .header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .campaign-title {
        font-size: 1.75rem;
    }
    
    .campaign-meta {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .tables-section {
        grid-template-columns: 1fr;
    }
    
    .stats-overview {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}

@media (max-width: 640px) {
    .analytics-header {
        padding: 2rem 1rem;
    }
    
    .campaign-title {
        font-size: 1.5rem;
    }
    
    .campaign-subtitle {
        font-size: 1rem;
    }
    
    .campaign-meta {
        font-size: 0.8125rem;
        gap: 1rem;
    }
    
    .stat-card {
        padding: 1.5rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .chart-card {
        padding: 1rem;
    }
    
    .chart-container {
        height: 300px;
    }
    
    .export-buttons {
        flex-direction: column;
        align-items: stretch;
    }
    
    .export-btn {
        min-width: auto;
    }
    
    .data-table {
        font-size: 0.8125rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 0.75rem;
    }
    
    .email-cell {
        max-width: 150px;
    }
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in-up {
    animation: fadeInUp 0.6s ease;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.animate-slide-in-left {
    animation: slideInLeft 0.4s ease;
}

/* Print Styles */
@media print {
    .analytics-header {
        background: #f8f9fa !important;
        color: #333 !important;
    }
    
    .action-btn,
    .chart-controls,
    .export-section {
        display: none !important;
    }
    
    .stat-card,
    .chart-card,
    .table-card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
    
    .charts-section,
    .tables-section {
        grid-template-columns: 1fr !important;
    }
    
    .chart-container {
        height: 300px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Analytics Header -->
    <div class="analytics-header animate-fade-in-up">
        <div class="header-content">
            <div class="header-left">
                <h1 class="campaign-title">{{ campaign.name }}</h1>
                <p class="campaign-subtitle">Campaign Performance Analytics</p>
                <div class="campaign-meta">
                    <div class="meta-item">
                        <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                        <span>Sent {{ campaign.sent_at.strftime('%B %d, %Y at %I:%M %p') if campaign.sent_at else 'Not sent yet' }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-users" aria-hidden="true"></i>
                        <span>{{ campaign.total_recipients or 0 }} recipients</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-envelope" aria-hidden="true"></i>
                        <span>{{ campaign.subject_line }}</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('campaigns.preview', id=campaign.id) }}" class="action-btn btn-white">
                    <i class="fas fa-eye" aria-hidden="true"></i>
                    Preview
                </a>
                <a href="{{ url_for('campaigns.edit', id=campaign.id) }}" class="action-btn btn-white">
                    <i class="fas fa-edit" aria-hidden="true"></i>
                    Edit
                </a>
            </div>
        </div>
    </div>
    
    <!-- Stats Overview -->
    <div class="stats-overview animate-slide-in-left" style="animation-delay: 0.1s">
        <div class="stat-card sent">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-paper-plane" aria-hidden="true"></i>
                </div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-arrow-up" aria-hidden="true"></i>
                    +0.0%
                </div>
            </div>
            <div class="stat-number">{{ campaign.total_sent or 0 }}</div>
            <div class="stat-label">Total Sent</div>
            <div class="stat-percentage">
                100%
                <i class="fas fa-info-circle" aria-hidden="true" title="Total emails sent"></i>
            </div>
        </div>
        
        <div class="stat-card delivered">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-check-circle" aria-hidden="true"></i>
                </div>
                <div class="stat-trend {% if (campaign.total_delivered or 0) / (campaign.total_sent or 1) >= 0.95 %}trend-up{% else %}trend-down{% endif %}">
                    <i class="fas fa-arrow-{% if (campaign.total_delivered or 0) / (campaign.total_sent or 1) >= 0.95 %}up{% else %}down{% endif %}" aria-hidden="true"></i>
                    {{ "%.1f"|format(((campaign.total_delivered or 0) / (campaign.total_sent or 1)) * 100 - 95) }}%
                </div>
            </div>
            <div class="stat-number">{{ campaign.total_delivered or 0 }}</div>
            <div class="stat-label">Delivered</div>
            <div class="stat-percentage">
                {{ "%.1f"|format(((campaign.total_delivered or 0) / (campaign.total_sent or 1)) * 100) }}%
                <i class="fas fa-info-circle" aria-hidden="true" title="Delivery rate"></i>
            </div>
        </div>
        
        <div class="stat-card opened">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-envelope-open" aria-hidden="true"></i>
                </div>
                <div class="stat-trend {% if (campaign.total_opened or 0) / (campaign.total_sent or 1) >= 0.20 %}trend-up{% else %}trend-down{% endif %}">
                    <i class="fas fa-arrow-{% if (campaign.total_opened or 0) / (campaign.total_sent or 1) >= 0.20 %}up{% else %}down{% endif %}" aria-hidden="true"></i>
                    {{ "%.1f"|format(((campaign.total_opened or 0) / (campaign.total_sent or 1)) * 100 - 20) }}%
                </div>
            </div>
            <div class="stat-number">{{ campaign.total_opened or 0 }}</div>
            <div class="stat-label">Unique Opens</div>
            <div class="stat-percentage">
                {{ "%.1f"|format(((campaign.total_opened or 0) / (campaign.total_sent or 1)) * 100) }}%
                <i class="fas fa-info-circle" aria-hidden="true" title="Open rate"></i>
            </div>
        </div>
        
        <div class="stat-card clicked">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-mouse-pointer" aria-hidden="true"></i>
                </div>
                <div class="stat-trend {% if (campaign.total_clicked or 0) / (campaign.total_sent or 1) >= 0.03 %}trend-up{% else %}trend-down{% endif %}">
                    <i class="fas fa-arrow-{% if (campaign.total_clicked or 0) / (campaign.total_sent or 1) >= 0.03 %}up{% else %}down{% endif %}" aria-hidden="true"></i>
                    {{ "%.1f"|format(((campaign.total_clicked or 0) / (campaign.total_sent or 1)) * 100 - 3) }}%
                </div>
            </div>
            <div class="stat-number">{{ campaign.total_clicked or 0 }}</div>
            <div class="stat-label">Unique Clicks</div>
            <div class="stat-percentage">
                {{ "%.1f"|format(((campaign.total_clicked or 0) / (campaign.total_sent or 1)) * 100) }}%
                <i class="fas fa-info-circle" aria-hidden="true" title="Click-through rate"></i>
            </div>
        </div>
        
        <div class="stat-card bounced">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                </div>
                <div class="stat-trend {% if (campaign.total_bounced or 0) / (campaign.total_sent or 1) <= 0.05 %}trend-up{% else %}trend-down{% endif %}">
                    <i class="fas fa-arrow-{% if (campaign.total_bounced or 0) / (campaign.total_sent or 1) <= 0.05 %}down{% else %}up{% endif %}" aria-hidden="true"></i>
                    {{ "%.1f"|format(abs(((campaign.total_bounced or 0) / (campaign.total_sent or 1)) * 100 - 5)) }}%
                </div>
            </div>
            <div class="stat-number">{{ campaign.total_bounced or 0 }}</div>
            <div class="stat-label">Bounced</div>
            <div class="stat-percentage">
                {{ "%.1f"|format(((campaign.total_bounced or 0) / (campaign.total_sent or 1)) * 100) }}%
                <i class="fas fa-info-circle" aria-hidden="true" title="Bounce rate"></i>
            </div>
        </div>
        
        <div class="stat-card unsubscribed">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-user-times" aria-hidden="true"></i>
                </div>
                <div class="stat-trend {% if (campaign.total_unsubscribed or 0) / (campaign.total_sent or 1) <= 0.01 %}trend-up{% else %}trend-down{% endif %}">
                    <i class="fas fa-arrow-{% if (campaign.total_unsubscribed or 0) / (campaign.total_sent or 1) <= 0.01 %}down{% else %}up{% endif %}" aria-hidden="true"></i>
                    {{ "%.2f"|format(abs(((campaign.total_unsubscribed or 0) / (campaign.total_sent or 1)) * 100 - 1)) }}%
                </div>
            </div>
            <div class="stat-number">{{ campaign.total_unsubscribed or 0 }}</div>
            <div class="stat-label">Unsubscribed</div>
            <div class="stat-percentage">
                {{ "%.2f"|format(((campaign.total_unsubscribed or 0) / (campaign.total_sent or 1)) * 100) }}%
                <i class="fas fa-info-circle" aria-hidden="true" title="Unsubscribe rate"></i>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-section animate-slide-in-left" style="animation-delay: 0.2s">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h2 class="chart-title">Performance Over Time</h2>
                    <p class="chart-subtitle">Track opens, clicks, and other engagement metrics</p>
                </div>
                <div class="chart-controls">
                    <div class="chart-toggle">
                        <button class="toggle-btn active" data-chart="hourly">Hourly</button>
                        <button class="toggle-btn" data-chart="daily">Daily</button>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h2 class="chart-title">Engagement Breakdown</h2>
                    <p class="chart-subtitle">Distribution of recipient actions</p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="engagementChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tables Section -->
    <div class="tables-section animate-slide-in-left" style="animation-delay: 0.3s">
        <div class="table-card">
            <div class="table-header">
                <h2 class="table-title">Top Performers</h2>
                <span class="table-count">{{ top_recipients|length }} recipients</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Opened</th>
                            <th>Clicked</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for recipient in top_recipients[:10] %}
                        <tr>
                            <td class="email-cell">{{ recipient.email }}</td>
                            <td>
                                <span class="status-badge badge-{{ recipient.status }}">
                                    {{ recipient.status|title }}
                                </span>
                            </td>
                            <td>{{ 'Yes' if recipient.opened_at else 'No' }}</td>
                            <td>{{ recipient.click_count or 0 }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--analytics-gray-500); padding: 2rem;">
                                No recipients data available
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="table-card">
            <div class="table-header">
                <h2 class="table-title">Link Performance</h2>
                <span class="table-count">{{ link_stats|length }} links</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Clicks</th>
                            <th>Unique</th>
                            <th>CTR</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for link in link_stats[:10] %}
                        <tr>
                            <td class="email-cell">
                                <a href="{{ link.url }}" target="_blank" rel="noopener">
                                    {{ link.url[:30] }}{% if link.url|length > 30 %}...{% endif %}
                                </a>
                            </td>
                            <td>{{ link.total_clicks }}</td>
                            <td>{{ link.unique_clicks }}</td>
                            <td>{{ "%.1f"|format((link.unique_clicks / (campaign.total_sent or 1)) * 100) }}%</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--analytics-gray-500); padding: 2rem;">
                                No link tracking data available
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Export Section -->
    <div class="export-section animate-fade-in-up" style="animation-delay: 0.4s">
        <h2 class="export-title">Export Campaign Data</h2>
        <p class="export-subtitle">
            Download detailed analytics and recipient data for further analysis or reporting purposes.
        </p>
        <div class="export-buttons">
            <a href="{{ url_for('campaigns.export', id=campaign.id, format='csv') }}" class="export-btn btn-outline-primary">
                <i class="fas fa-file-csv" aria-hidden="true"></i>
                Export CSV
            </a>
            <a href="{{ url_for('campaigns.export', id=campaign.id, format='excel') }}" class="export-btn btn-outline-success">
                <i class="fas fa-file-excel" aria-hidden="true"></i>
                Export Excel
            </a>
            <a href="{{ url_for('campaigns.export', id=campaign.id, format='pdf') }}" class="export-btn btn-outline-warning">
                <i class="fas fa-file-pdf" aria-hidden="true"></i>
                Export PDF
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Advanced Analytics Dashboard System
class AnalyticsDashboard {
    constructor() {
        this.charts = {};
        this.currentTimeFrame = 'hourly';
        
        this.init();
    }
    
    init() {
        this.setupChartToggles();
        this.initializeCharts();
        this.setupExportHandlers();
        
        console.log('Analytics Dashboard initialized');
    }
    
    setupChartToggles() {
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const chartType = e.target.dataset.chart;
                
                // Update active state
                e.target.parentElement.querySelectorAll('.toggle-btn').forEach(b => {
                    b.classList.remove('active');
                });
                e.target.classList.add('active');
                
                // Update chart
                this.currentTimeFrame = chartType;
                this.updatePerformanceChart();
            });
        });
    }
    
    initializeCharts() {
        this.createPerformanceChart();
        this.createEngagementChart();
    }
    
    createPerformanceChart() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        // Generate sample data - in production, this would come from the backend
        const hourlyData = this.generateHourlyData();
        const dailyData = this.generateDailyData();
        
        this.charts.performance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hourlyData.labels,
                datasets: [
                    {
                        label: 'Opens',
                        data: hourlyData.opens,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Clicks',
                        data: hourlyData.clicks,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Bounces',
                        data: hourlyData.bounces,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: 600
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6b7280',
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: '#6b7280',
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutCubic'
                }
            }
        });
    }
    
    createEngagementChart() {
        const ctx = document.getElementById('engagementChart').getContext('2d');
        
        const totalSent = {{ campaign.total_sent or 0 }};
        const totalOpened = {{ campaign.total_opened or 0 }};
        const totalClicked = {{ campaign.total_clicked or 0 }};
        const totalBounced = {{ campaign.total_bounced or 0 }};
        const totalUnsubscribed = {{ campaign.total_unsubscribed or 0 }};
        
        const noAction = totalSent - totalOpened - totalBounced - totalUnsubscribed;
        
        this.charts.engagement = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Opened', 'Clicked', 'Bounced', 'Unsubscribed', 'No Action'],
                datasets: [{
                    data: [totalOpened, totalClicked, totalBounced, totalUnsubscribed, noAction],
                    backgroundColor: [
                        '#f59e0b',
                        '#8b5cf6', 
                        '#ef4444',
                        '#f97316',
                        '#e5e7eb'
                    ],
                    borderWidth: 0,
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: 600
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const percentage = totalSent > 0 ? ((value / totalSent) * 100).toFixed(1) : '0.0';
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%',
                animation: {
                    animateRotate: true,
                    duration: 1000,
                    easing: 'easeInOutCubic'
                }
            }
        });
    }
    
    updatePerformanceChart() {
        const data = this.currentTimeFrame === 'hourly' ? 
                     this.generateHourlyData() : 
                     this.generateDailyData();
        
        this.charts.performance.data.labels = data.labels;
        this.charts.performance.data.datasets[0].data = data.opens;
        this.charts.performance.data.datasets[1].data = data.clicks;
        this.charts.performance.data.datasets[2].data = data.bounces;
        
        this.charts.performance.update('active');
    }
    
    generateHourlyData() {
        const hours = Array.from({length: 24}, (_, i) => 
            `${i.toString().padStart(2, '0')}:00`
        );
        
        // Simulate realistic email engagement patterns
        const openPattern = [
            1, 1, 2, 3, 5, 8, 15, 28, 45, 38, 42, 48,
            35, 32, 40, 44, 38, 35, 30, 22, 15, 10, 5, 2
        ];
        
        const clickRate = 0.15; // 15% of opens result in clicks
        const bounceRate = 0.03; // 3% bounce rate
        
        return {
            labels: hours,
            opens: openPattern.map(opens => 
                Math.floor(opens * ({{ campaign.total_opened or 0 }} / 100))
            ),
            clicks: openPattern.map(opens => 
                Math.floor(opens * clickRate * ({{ campaign.total_clicked or 0 }} / 100))
            ),
            bounces: openPattern.map(opens => 
                Math.floor(opens * bounceRate * ({{ campaign.total_bounced or 0 }} / 100))
            )
        };
    }
    
    generateDailyData() {
        const days = [];
        const today = new Date();
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        }
        
        // Simulate daily patterns (campaign sent on day 3)
        const dailyOpens = [0, 0, 0, 65, 25, 8, 2];
        const dailyClicks = [0, 0, 0, 45, 35, 15, 5];
        const dailyBounces = [0, 0, 0, 85, 10, 3, 2];
        
        return {
            labels: days,
            opens: dailyOpens,
            clicks: dailyClicks,
            bounces: dailyBounces
        };
    }
    
    setupExportHandlers() {
        // Add loading states to export buttons
        document.querySelectorAll('.export-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                this.style.pointerEvents = 'none';
                
                // Re-enable after 3 seconds (typical export time)
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.style.pointerEvents = 'auto';
                }, 3000);
            });
        });
    }
    
    // Utility method to refresh all data
    refreshData() {
        // In a real application, this would fetch fresh data from the server
        console.log('Refreshing analytics data...');
        
        // Update charts with new data
        this.updatePerformanceChart();
        
        // Show success message
        this.showNotification('Analytics data refreshed successfully!', 'success');
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            background: ${type === 'success' ? '#10b981' : '#2563eb'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} fa-lg"></i>
                <span>${message}</span>
                <button onclick="this.closest('.notification').remove()" 
                        style="background: none; border: none; color: white; margin-left: auto; cursor: pointer; font-size: 1.25rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + R to refresh data
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        if (window.analyticsDashboard) {
            window.analyticsDashboard.refreshData();
        }
    }
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Initialize the analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    window.analyticsDashboard = new AnalyticsDashboard();
});
</script>
{% endblock %}

