<!-- templates/auth/login.html -->
{% extends "base.html" %}

{% block title %}Secure Login{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
/* Enhanced authentication styles */
.auth-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
    overflow: hidden;
}

.auth-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill=%23ffffff10' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
    animation: float 20s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.login-card {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.login-card:hover {
    transform: translateY(-5px);
}

.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}

.step {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 10px;
    font-weight: 600;
    position: relative;
    transition: all 0.3s ease;
}

.step.active {
    background: var(--bs-primary);
    color: white;
}

.step.completed {
    background: var(--bs-success);
    color: white;
}

.step::after {
    content: '';
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 2px;
    background: #e9ecef;
    z-index: -1;
}

.step:last-child::after {
    display: none;
}

.step.completed::after {
    background: var(--bs-success);
}

.auth-step {
    display: none;
}

.auth-step.active {
    display: block;
    animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.security-badge {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 1px solid rgba(40, 167, 69, 0.2);
    font-size: 0.875rem;
}

.strength-meter {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.strength-bar {
    height: 100%;
    width: 0%;
    transition: all 0.3s ease;
    border-radius: 2px;
}

.floating-label {
    position: relative;
}

.floating-label input {
    padding-top: 1.5rem;
    padding-bottom: 0.5rem;
}

.floating-label label {
    position: absolute;
    top: 1rem;
    left: 0.75rem;
    color: #6c757d;
    transition: all 0.2s ease;
    pointer-events: none;
    background: white;
    padding: 0 0.25rem;
    z-index: 5;
}

.floating-label input:focus + label,
.floating-label input:not(:placeholder-shown) + label {
    top: -0.5rem;
    font-size: 0.75rem;
    color: var(--bs-primary);
}

.totp-input-group {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.totp-digit {
    width: 50px;
    height: 50px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.totp-digit:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.biometric-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    transition: all 0.3s ease;
}

.biometric-button:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="auth-container d-flex align-items-center justify-content-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5 col-xl-4">
                <!-- Login Card -->
                <div class="login-card p-4">
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <div class="auth-logo mb-3">
                            <div class="brand-icon bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px;">
                                <i class="fas fa-envelope-open-text text-white fa-2x" aria-hidden="true"></i>
                            </div>
                        </div>
                        <h1 class="h4 mb-2 text-dark">Welcome Back</h1>
                        <p class="text-muted mb-0">Sign in to Email Sender Pro</p>
                    </div>
                    
                    <!-- Multi-step Authentication Form -->
                    <form id="auth-form" method="POST" action="{{ url_for('auth.login') }}" novalidate>
                        <!-- CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="current_step" id="current-step" value="credentials">
                        <input type="hidden" name="device_fingerprint" id="device-fingerprint">
                        
                        <!-- Step Indicator -->
                        <div class="step-indicator" id="step-indicator">
                            <div class="step active" data-step="credentials">
                                <i class="fas fa-user" aria-hidden="true"></i>
                            </div>
                            <div class="step" data-step="verification">
                                <i class="fas fa-shield-alt" aria-hidden="true"></i>
                            </div>
                            <div class="step" data-step="success">
                                <i class="fas fa-check" aria-hidden="true"></i>
                            </div>
                        </div>
                        
                        <!-- Step 1: Credentials -->
                        <div class="auth-step active" id="step-credentials">
                            <div class="mb-3">
                                <div class="floating-label">
                                    <input type="text" 
                                           class="form-control" 
                                           id="username" 
                                           name="username"
                                           placeholder=" "
                                           autocomplete="username"
                                           required 
                                           aria-describedby="username-error"
                                           data-validation="required,email_or_username">
                                    <label for="username">Username or Email</label>
                                </div>
                                <div id="username-error" class="invalid-feedback" role="alert"></div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="floating-label">
                                    <input type="password" 
                                           class="form-control" 
                                           id="password" 
                                           name="password"
                                           placeholder=" "
                                           autocomplete="current-password"
                                           required 
                                           aria-describedby="password-error password-strength"
                                           data-validation="required,minLength:8">
                                    <label for="password">Password</label>
                                    <button type="button" 
                                            class="btn btn-sm btn-link position-absolute top-50 end-0 translate-middle-y me-3" 
                                            id="toggle-password"
                                            aria-label="Toggle password visibility"
                                            tabindex="-1">
                                        <i class="fas fa-eye text-muted" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="strength-meter" id="password-strength" aria-hidden="true">
                                    <div class="strength-bar"></div>
                                </div>
                                <div id="password-error" class="invalid-feedback" role="alert"></div>
                            </div>
                            
                            <!-- Remember Device -->
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="remember_device" name="remember_device">
                                <label class="form-check-label" for="remember_device">
                                    <i class="fas fa-mobile-alt me-1" aria-hidden="true"></i>
                                    Trust this device for 30 days
                                </label>
                            </div>
                            
                            <!-- Biometric Authentication (if supported) -->
                            <div class="mb-3 d-none" id="biometric-container">
                                <div class="text-center">
                                    <button type="button" class="biometric-button" id="biometric-auth">
                                        <i class="fas fa-fingerprint me-2" aria-hidden="true"></i>
                                        Use Biometric Authentication
                                    </button>
                                    <p class="small text-muted mt-2 mb-0">
                                        Use your fingerprint or face to sign in securely
                                    </p>
                                </div>
                            </div>
                            
                            <div class="d-grid mb-3">
                                <button type="button" class="btn btn-primary btn-lg" id="continue-btn">
                                    <span class="btn-text">Continue</span>
                                    <span class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 2: 2FA Verification -->
                        <div class="auth-step" id="step-verification">
                            <div class="text-center mb-4">
                                <div class="verification-icon mb-3">
                                    <i class="fas fa-mobile-alt text-primary fa-3x" aria-hidden="true"></i>
                                </div>
                                <h5 class="mb-2">Two-Factor Authentication</h5>
                                <p class="text-muted mb-0" id="verification-message">
                                    Enter the 6-digit code from your authenticator app
                                </p>
                            </div>
                            
                            <!-- TOTP Code Input -->
                            <div class="mb-4" id="totp-container">
                                <div class="totp-input-group" role="group" aria-labelledby="totp-label">
                                    <span id="totp-label" class="visually-hidden">Enter 6-digit authentication code</span>
                                    <input type="text" class="totp-digit" maxlength="1" pattern="[0-9]" autocomplete="one-time-code" aria-label="Digit 1">
                                    <input type="text" class="totp-digit" maxlength="1" pattern="[0-9]" autocomplete="one-time-code" aria-label="Digit 2">
                                    <input type="text" class="totp-digit" maxlength="1" pattern="[0-9]" autocomplete="one-time-code" aria-label="Digit 3">
                                    <input type="text" class="totp-digit" maxlength="1" pattern="[0-9]" autocomplete="one-time-code" aria-label="Digit 4">
                                    <input type="text" class="totp-digit" maxlength="1" pattern="[0-9]" autocomplete="one-time-code" aria-label="Digit 5">
                                    <input type="text" class="totp-digit" maxlength="1" pattern="[0-9]" autocomplete="one-time-code" aria-label="Digit 6">
                                </div>
                                <input type="hidden" name="totp_code" id="totp-code-hidden">
                                <div id="totp-error" class="invalid-feedback text-center mt-2" role="alert"></div>
                            </div>
                            
                            <!-- Backup Options -->
                            <div class="text-center mb-4">
                                <button type="button" class="btn btn-link btn-sm" id="use-backup-code">
                                    <i class="fas fa-key me-1" aria-hidden="true"></i>
                                    Use backup code instead
                                </button>
                                <br>
                                <button type="button" class="btn btn-link btn-sm" id="resend-code" disabled>
                                    <i class="fas fa-redo me-1" aria-hidden="true"></i>
                                    Resend code in <span id="resend-timer">30</span>s
                                </button>
                            </div>
                            
                            <!-- Backup Code Input (Hidden by default) -->
                            <div class="mb-4 d-none" id="backup-code-container">
                                <div class="floating-label">
                                    <input type="text" 
                                           class="form-control text-center" 
                                           id="backup-code" 
                                           name="backup_code"
                                           placeholder=" "
                                           maxlength="8"
                                           aria-describedby="backup-code-help">
                                    <label for="backup-code">8-Character Backup Code</label>
                                </div>
                                <div id="backup-code-help" class="form-text text-center">
                                    Enter one of your backup codes (letters and numbers)
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="verify-btn" disabled>
                                    <span class="btn-text">Verify & Sign In</span>
                                    <span class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="back-to-credentials">
                                    <i class="fas fa-arrow-left me-2" aria-hidden="true"></i>
                                    Back to Login
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Success -->
                        <div class="auth-step" id="step-success">
                            <div class="text-center">
                                <div class="success-icon mb-3">
                                    <i class="fas fa-check-circle text-success fa-4x" aria-hidden="true"></i>
                                </div>
                                <h5 class="mb-2 text-success">Authentication Successful!</h5>
                                <p class="text-muted mb-4">Redirecting you to your dashboard...</p>
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Additional Options -->
                    <div class="auth-step active" id="step-options">
                        <hr class="my-4">
                        <div class="text-center">
                            <a href="{{ url_for('auth.forgot_password') }}" 
                               class="btn btn-link btn-sm text-decoration-none">
                                <i class="fas fa-question-circle me-1" aria-hidden="true"></i>
                                Forgot your password?
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Security Information -->
                <div class="text-center mt-4">
                    <div class="security-badge d-inline-flex align-items-center">
                        <i class="fas fa-shield-alt me-2" aria-hidden="true"></i>
                        <span>256-bit SSL Encryption</span>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="text-center mt-3">
                    <small class="text-white-50">
                        System Status: 
                        <span class="badge bg-success ms-1" id="system-status">
                            <i class="fas fa-circle me-1" aria-hidden="true"></i>
                            Online
                        </span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/auth/login.js') }}"></script>
<script>
// Enhanced Login System
class EnhancedLoginSystem {
    constructor() {
        this.currentStep = 'credentials';
        this.totpCode = '';
        this.resendTimer = 30;
        this.maxAttempts = 3;
        this.attempts = 0;
        this.deviceFingerprint = null;
        
        this.init();
    }
    
    init() {
        this.generateDeviceFingerprint();
        this.setupEventListeners();
        this.checkBiometricSupport();
        this.initializePasswordStrength();
        this.setupTOTPInput();
    }
    
    generateDeviceFingerprint() {
        // Generate unique device fingerprint
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Device fingerprint', 2, 2);
        
        const fingerprint = [
            navigator.userAgent,
            navigator.language,
            screen.width + 'x' + screen.height,
            new Date().getTimezoneOffset(),
            canvas.toDataURL()
        ].join('|');
        
        this.deviceFingerprint = btoa(fingerprint).substring(0, 32);
        document.getElementById('device-fingerprint').value = this.deviceFingerprint;
    }
    
    setupEventListeners() {
        // Continue button
        document.getElementById('continue-btn').addEventListener('click', (e) => {
            e.preventDefault();
            this.validateCredentials();
        });
        
        // Password toggle
        document.getElementById('toggle-password').addEventListener('click', () => {
            this.togglePassword();
        });
        
        // Back to credentials
        document.getElementById('back-to-credentials').addEventListener('click', () => {
            this.goToStep('credentials');
        });
        
        // Backup code toggle
        document.getElementById('use-backup-code').addEventListener('click', () => {
            this.toggleBackupCode();
        });
        
        // Form submission
        document.getElementById('auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitAuthentication();
        });
        
        // Biometric authentication
        const biometricBtn = document.getElementById('biometric-auth');
        if (biometricBtn) {
            biometricBtn.addEventListener('click', () => {
                this.authenticateWithBiometric();
            });
        }
        
        // Real-time validation
        document.getElementById('username').addEventListener('input', 
            this.debounce((e) => this.validateField(e.target), 500));
        document.getElementById('password').addEventListener('input', 
            this.debounce((e) => this.validateField(e.target), 300));
    }
    
    checkBiometricSupport() {
        if ('credentials' in navigator && 'create' in navigator.credentials) {
            // Check if biometric authentication is available
            navigator.credentials.get({
                publicKey: {
                    challenge: new Uint8Array(32),
                    allowCredentials: []
                }
            }).then(() => {
                document.getElementById('biometric-container').classList.remove('d-none');
            }).catch(() => {
                // Biometric not available
            });
        }
    }
    
    initializePasswordStrength() {
        const passwordInput = document.getElementById('password');
        const strengthBar = document.querySelector('.strength-bar');
        
        passwordInput.addEventListener('input', (e) => {
            const strength = this.calculatePasswordStrength(e.target.value);
            this.updateStrengthMeter(strengthBar, strength);
        });
    }
    
    calculatePasswordStrength(password) {
        let score = 0;
        
        // Length
        if (password.length >= 8) score += 20;
        if (password.length >= 12) score += 20;
        
        // Character types
        if (/[a-z]/.test(password)) score += 15;
        if (/[A-Z]/.test(password)) score += 15;
        if (/[0-9]/.test(password)) score += 15;
        if (/[^a-zA-Z0-9]/.test(password)) score += 15;
        
        return Math.min(score, 100);
    }
    
    updateStrengthMeter(bar, strength) {
        bar.style.width = `${strength}%`;
        
        if (strength < 30) {
            bar.className = 'strength-bar bg-danger';
        } else if (strength < 60) {
            bar.className = 'strength-bar bg-warning';
        } else if (strength < 80) {
            bar.className = 'strength-bar bg-info';
        } else {
            bar.className = 'strength-bar bg-success';
        }
    }
    
    setupTOTPInput() {
        const digits = document.querySelectorAll('.totp-digit');
        
        digits.forEach((digit, index) => {
            digit.addEventListener('input', (e) => {
                // Only allow numbers
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                
                // Auto-advance to next field
                if (e.target.value && index < digits.length - 1) {
                    digits[index + 1].focus();
                }
                
                this.updateTOTPCode();
            });
            
            digit.addEventListener('keydown', (e) => {
                // Handle backspace
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    digits[index - 1].focus();
                }
            });
            
            // Auto-select on focus
            digit.addEventListener('focus', (e) => {
                e.target.select();
            });
        });
    }
    
    updateTOTPCode() {
        const digits = document.querySelectorAll('.totp-digit');
        this.totpCode = Array.from(digits).map(d => d.value).join('');
        document.getElementById('totp-code-hidden').value = this.totpCode;
        
        // Enable verify button when code is complete
        const verifyBtn = document.getElementById('verify-btn');
        if (this.totpCode.length === 6) {
            verifyBtn.disabled = false;
        } else {
            verifyBtn.disabled = true;
        }
    }
    
    async validateCredentials() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Client-side validation
        if (!username || !password) {
            this.showError('Please fill in all fields');
            return;
        }
        
        // Show loading state
        this.setLoading('continue-btn', true);
        
        try {
            const response = await fetch('/api/auth/validate-credentials', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    device_fingerprint: this.deviceFingerprint
                })
            });
            
            const data = await response.json();
            this.setLoading('continue-btn', false);
            
            if (data.success) {
                if (data.requires_2fa) {
                    this.goToStep('verification');
                    this.startResendTimer();
                } else {
                    // Direct login success
                    this.goToStep('success');
                    setTimeout(() => {
                        window.location.href = data.redirect_url || '/dashboard';
                    }, 2000);
                }
            } else {
                this.showError(data.message || 'Invalid credentials');
                this.attempts++;
                
                if (this.attempts >= this.maxAttempts) {
                    this.lockForm();
                }
            }
        } catch (error) {
            this.setLoading('continue-btn', false);
            this.showError('Network error. Please try again.');
        }
    }
    
    async submitAuthentication() {
        const formData = new FormData(document.getElementById('auth-form'));
        formData.set('totp_code', this.totpCode);
        
        this.setLoading('verify-btn', true);
        
        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            this.setLoading('verify-btn', false);
            
            if (data.success) {
                this.goToStep('success');
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/dashboard';
                }, 2000);
            } else {
                this.showError(data.message || 'Verification failed');
                this.clearTOTPInput();
            }
        } catch (error) {
            this.setLoading('verify-btn', false);
            this.showError('Network error. Please try again.');
        }
    }
    
    async authenticateWithBiometric() {
        try {
            const credential = await navigator.credentials.get({
                publicKey: {
                    challenge: new TextEncoder().encode('login-challenge'),
                    allowCredentials: [{
                        type: 'public-key',
                        id: new TextEncoder().encode(this.deviceFingerprint)
                    }],
                    userVerification: 'required'
                }
            });
            
            // Send biometric auth to server
            const response = await fetch('/api/auth/biometric-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({
                    credential: credential,
                    device_fingerprint: this.deviceFingerprint
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.goToStep('success');
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/dashboard';
                }, 2000);
            }
        } catch (error) {
            console.log('Biometric authentication failed:', error);
        }
    }
    
    goToStep(step) {
        // Update step indicator
        document.querySelectorAll('.step').forEach(s => {
            s.classList.remove('active', 'completed');
            if (s.dataset.step === this.currentStep) {
                s.classList.add('completed');
            }
        });
        
        document.querySelector(`[data-step="${step}"]`).classList.add('active');
        
        // Update step content
        document.querySelectorAll('.auth-step').forEach(s => {
            s.classList.remove('active');
        });
        
        document.getElementById(`step-${step}`).classList.add('active');
        
        // Show/hide options
        const optionsStep = document.getElementById('step-options');
        if (step === 'credentials') {
            optionsStep.classList.add('active');
        } else {
            optionsStep.classList.remove('active');
        }
        
        this.currentStep = step;
        document.getElementById('current-step').value = step;
    }
    
    startResendTimer() {
        this.resendTimer = 30;
        const resendBtn = document.getElementById('resend-code');
        const timerSpan = document.getElementById('resend-timer');
        
        const timer = setInterval(() => {
            this.resendTimer--;
            timerSpan.textContent = this.resendTimer;
            
            if (this.resendTimer <= 0) {
                clearInterval(timer);
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo me-1"></i>Resend code';
            }
        }, 1000);
    }
    
    togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleBtn = document.getElementById('toggle-password');
        const icon = toggleBtn.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.className = 'fas fa-eye-slash text-muted';
            toggleBtn.setAttribute('aria-label', 'Hide password');
        } else {
            passwordInput.type = 'password';
            icon.className = 'fas fa-eye text-muted';
            toggleBtn.setAttribute('aria-label', 'Show password');
        }
    }
    
    toggleBackupCode() {
        const totpContainer = document.getElementById('totp-container');
        const backupContainer = document.getElementById('backup-code-container');
        const toggleBtn = document.getElementById('use-backup-code');
        
        if (backupContainer.classList.contains('d-none')) {
            // Show backup code input
            totpContainer.style.display = 'none';
            backupContainer.classList.remove('d-none');
            toggleBtn.innerHTML = '<i class="fas fa-mobile-alt me-1"></i>Use authenticator app instead';
            document.getElementById('backup-code').focus();
        } else {
            // Show TOTP input
            totpContainer.style.display = 'block';
            backupContainer.classList.add('d-none');
            toggleBtn.innerHTML = '<i class="fas fa-key me-1"></i>Use backup code instead';
            document.querySelector('.totp-digit').focus();
        }
    }
    
    clearTOTPInput() {
        document.querySelectorAll('.totp-digit').forEach(digit => {
            digit.value = '';
        });
        this.totpCode = '';
        document.getElementById('totp-code-hidden').value = '';
        document.getElementById('verify-btn').disabled = true;
    }
    
    setLoading(buttonId, loading) {
        const button = document.getElementById(buttonId);
        const text = button.querySelector('.btn-text');
        const spinner = button.querySelector('.spinner-border');
        
        if (loading) {
            button.disabled = true;
            if (text) text.style.opacity = '0.7';
            if (spinner) spinner.classList.remove('d-none');
        } else {
            button.disabled = false;
            if (text) text.style.opacity = '1';
            if (spinner) spinner.classList.add('d-none');
        }
    }
    
    showError(message) {
        if (window.alertSystem) {
            window.alertSystem.error(message);
        } else {
            alert(message);
        }
    }
    
    validateField(field) {
        // Implement real-time field validation
        const validation = field.dataset.validation;
        if (validation) {
            // Add validation logic here
        }
    }
    
    lockForm() {
        // Lock form after too many failed attempts
        const form = document.getElementById('auth-form');
        form.style.opacity = '0.5';
        form.style.pointerEvents = 'none';
        
        this.showError('Too many failed attempts. Please try again in 15 minutes.');
    }
    
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// Initialize login system
document.addEventListener('DOMContentLoaded', function() {
    window.loginSystem = new EnhancedLoginSystem();
    
    // Monitor system status
    setInterval(() => {
        fetch('/health')
            .then(response => response.json())
            .then(data => {
                const statusBadge = document.getElementById('system-status');
                if (data.status === 'healthy') {
                    statusBadge.className = 'badge bg-success ms-1';
                    statusBadge.innerHTML = '<i class="fas fa-circle me-1"></i>Online';
                } else {
                    statusBadge.className = 'badge bg-warning ms-1';
                    statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Issues';
                }
            })
            .catch(() => {
                const statusBadge = document.getElementById('system-status');
                statusBadge.className = 'badge bg-danger ms-1';
                statusBadge.innerHTML = '<i class="fas fa-times me-1"></i>Offline';
            });
    }, 30000); // Check every 30 seconds
});
</script>
{% endblock %}

